name: TCP Command and Scripting Interpreter Outbound LDAP Traffic
id: 4d16a90c-d1a9-4d17-8156-d0db0c73c449
version: 1
description: Malicious actors often abuse misconfigured LDAP servers or applications
  that use the LDAP servers in organizations. Outbound LDAP traffic should not be
  allowed outbound through your perimeter firewall. This search will help determine
  if you have any LDAP connections to IP addresses outside of private (RFC1918) address
  space.
search: '| from read_ssa_enriched_events() | eval timestamp=parse_long(ucast(map_get(input_event,
  "_time"), "string", null)), dest_port=map_get(input_event, "dest_port"), event_id=ucast(map_get(input_event,
  "event_id"), "string", null), dest_device_ips=ucast(map_get(input_event, "dest_device_ips"),
  "collection<string>", [])[0], dest_user_id=ucast(map_get(input_event, "dest_user_id"),
  "string", null), dest_device_id=ucast(map_get(input_event, "dest_device_id"), "string",
  null) | where dest_port=389 OR dest_port=1389 OR dest_port=636 | where NOT (cidrmatch(ip:
  dest_device_ips, cidr_range: "10.0.0.0/8") OR cidrmatch(ip: dest_device_ips, cidr_range:
  "192.168.0.0/16") OR cidrmatch(ip: dest_device_ips, cidr_range: "172.16.0.0/12"))
  | eval body=create_map("category_id", 101, "class_id", 101000, "detection_start_time", timestamp, 
  "detection_end_time", timestamp, "device_entities", [create_map("uid", ucast(map_get(input_event, "tbd"), "string", null), "type_id", 0)], 
  "disposition_id", 1, "end_time", timestamp, "event_id", 10100001, "event_time", timestamp, 
  "finding", create_map("confidence", 70, "confidence_id", 3, 
  "context_ids", [23, 10, 42], "impact", 50, "impact_id", 3,
  "kill_chain_phase", "Exploitation", "kill_chain_phase_id", 4, 
  "risk_level", "Low", "risk_level_id", 1, "type_id", 1, "ref_event_uid", event_id), 
  "message", "An outbound LDAP connection from $src_ip$ in your infrastructure connecting to dest ip $dest_ip$", "metadata", create_map("log_name", "Endpoint_Processes", "version",
  "1.0.0"), "observables", [create_map("name", "dest_user_id", "role_ids", [4], "type_id", 6, "value", dest_user_id), create_map("name", "dest_device_id", "role_ids", [4], "type_id", 4, "value", dest_device_id)], "origin", create_map("product", create_map("name", "Splunk Behavioral Analytics")), 
  "rule", create_map("name", "TCP Command and Scripting Interpreter Outbound LDAP Traffic"), "start_time", timestamp, "time", timestamp,
  "user_entities", [create_map("uid", "tbd")]) | into write_ssa_finding_events();'
how_to_implement: To successfully implement this search you need to be ingesting information
  on network traffic, specifically data that populates the Network_Traffic datamodel.
  To develop this analytic we used specifically Zeek/Bro conn.log and PAN Traffic
  events.
known_false_positives: Unknown at this moment. Outbound LDAP traffic should not be
  allowed outbound through your perimeter firewall. Please check those servers to
  verify if the activity is legitimate.
references:
- https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/
- https://www.splunk.com/en_us/blog/security/simulating-detecting-and-responding-to-log4shell-with-splunk.html
- https://www.cisa.gov/uscert/ncas/alerts/aa21-356a
tags:
  analytic_story:
  - Log4Shell CVE-2021-44228
  cis20:
  - CIS 13
  kill_chain_phases:
  - Exploitation
  mitre_attack_id:
  - T1059
  nist:
  - PR.PT
  - DE.CM
  required_fields:
  - _time
  - dest_device_id
  - process_name
  - parent_process_name
  - process_path
  - dest_user_id
  - process
  - cmd_line
  risk_score: 35
  security_domain: network
  risk_severity: low
test:
  name: TCP Command and Scripting Interpreter Outbound LDAP Traffic Unit Test
  tests:
  - name: TCP Command and Scripting Interpreter Outbound LDAP Traffic
    file: network/ssa___tcp_command_and_scripting_interpreter_outbound_ldap_traffic.yml
    pass_condition: '@count_gt(0)'
    attack_data:
    - file_name: pantraffic.txt
      data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1059/log4shell_ldap_traffic/pantraffic.log
      source: pan:traffic
