name: DNS Exfiltration Using Nslookup App
id: 2452e632-9e0d-11eb-34ba-acde48001122
version: 1
description: This search is to detect potential DNS exfiltration using nslookup application.
  This technique are seen in couple of malware and APT group to exfiltrated collected
  data in a infected machine or infected network. This detection is looking for unique
  use of nslookup where it tries to use specific record type, TXT, A, AAAA, that are
  commonly used by attacker and also the retry parameter which is designed to query
  C2 DNS multiple tries.
search: '| from read_ssa_enriched_events() | eval timestamp=parse_long(ucast(map_get(input_event,
  "_time"), "string", null)), process=ucast(map_get(input_event, "process"), "string",
  null), process_name=ucast(map_get(input_event, "process_name"), "string", null),
  process_path=ucast(map_get(input_event, "process_path"), "string", null), parent_process_name=ucast(map_get(input_event,
  "parent_process_name"), "string", null), event_id=ucast(map_get(input_event, "event_id"),
  "string", null), dest_user_id=ucast(map_get(input_event, "dest_user_id"), "string",
  null), dest_device_id=ucast(map_get(input_event, "dest_device_id"), "string", null)
  | where process IS NOT NULL AND process_name IS NOT NULL AND process_name="nslookup.exe"
  AND (like (process, "%-querytype=%") OR like (process, "%-qt=%") OR like (process,
  "%-q=%") OR like (process, "%-type=%") OR like (process, "%-retry=%")) | eval body=create_map("category_id", 101, "class_id", 101000, "detection_start_time", timestamp, 
  "detection_end_time", timestamp, "device_entities", [create_map("uid", ucast(map_get(input_event, "tbd"), "string", null), "type_id", 0)], 
  "disposition_id", 1, "end_time", timestamp, "event_id", 10100001, "event_time", timestamp, 
  "finding", create_map("confidence", 80, "confidence_id", 3, 
  "context_ids", [10, 50], "impact", 90, "impact_id", 5,
  "kill_chain_phase", "Exploitation", "kill_chain_phase_id", 4, 
  "risk_level", "High", "risk_level_id", 3, "type_id", 1, "ref_event_uid", event_id), 
  "message", "An instance of $parent_process_name$ spawning $process_name$ was identified on endpoint $dest_device_id$ by user $dest_user_id$ performing activity related to DNS exfiltration.", "metadata", create_map("log_name", "Endpoint_Processes", "version",
  "1.0.0"), "observables", [create_map("name", "dest_user_id", "role_ids", [4], "type_id", 6, "value", dest_user_id), create_map("name", "dest_device_id", "role_ids", [4], "type_id", 4, "value", dest_device_id), create_map("name", "parent_process_name", "role_ids", [5], "type_id", 15, "value", parent_process_name), create_map("name", "process_name", "role_ids", [6], "type_id", 15, "value", process_name)], "origin", create_map("product", create_map("name", "Splunk Behavioral Analytics")), 
  "rule", create_map("name", "DNS Exfiltration Using Nslookup App"), "start_time", timestamp, "time", timestamp,
  "user_entities", [create_map("uid", "tbd")])
  | into write_ssa_finding_events();'
how_to_implement: To successfully implement this search you need to be ingesting information
  on process that include the name of the process responsible for the changes from
  your endpoints into the `Endpoint_Processess` datamodel.
known_false_positives: It is possible for some legitimate administrative utilities
  to use similar process parameters. Filter as needed.
references:
- https://www.fireeye.com/blog/threat-research/2017/03/fin7_spear_phishing.html
- https://www.varonis.com/blog/dns-tunneling/
- https://www.microsoft.com/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/
tags:
  analytic_story:
  - Suspicious DNS Traffic
  - Dynamic DNS
  - Data Exfiltration
  - Command and Control
  cis20: []
  kill_chain_phases:
  - Exploitation
  mitre_attack_id:
  - T1048
  nist: []
  required_fields:
  - _time
  - dest_device_id
  - process_name
  - parent_process_name
  - process_path
  - dest_user_id
  - process
  - process
  risk_score: 72
  security_domain: endpoint
  risk_severity: medium
test:
  name: DNS Exfiltration Using Nslookup App Unit Test
  tests:
  - name: DNS Exfiltration Using Nslookup App
    file: endpoint/ssa_dns_exfiltration_using_nslookup_app.yml
    pass_condition: '@count_gt(0)'
    attack_data:
    - file_name: windows-security.log
      data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1048.003/nslookup_exfil/windows-security.log
      source: WinEventLog:Security
