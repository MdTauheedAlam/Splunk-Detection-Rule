name: Detect Prohibited Applications Spawning cmd exe
id: c10a18cb-fd80-4ffa-a844-25026e0a0c94
version: 3
description: The following analytic identifies parent processes, browsers, Windows
  terminal applications, Office Products and Java spawning cmd.exe. By its very nature,
  many applications spawn cmd.exe natively or built into macros. Much of this will
  need to be tuned to further enhance the risk.
search: '| from read_ssa_enriched_events() | eval timestamp=parse_long(ucast(map_get(input_event,
  "_time"), "string", null)) | eval process_name=ucast(map_get(input_event, "process_name"),
  "string", null), process = lower(ucast(map_get(input_event, "process"),"string",
  null)), dest_user_id=ucast(map_get(input_event, "dest_user_id"), "string", null),
  dest_device_id=ucast(map_get(input_event, "dest_device_id"), "string", null), event_id=ucast(map_get(input_event,"event_id"),
  "string", null), parent_process_name=ucast(map_get(input_event, "parent_process_name"),
  "string", null) | where process_name="cmd.exe" | rex field=parent_process_name "(?<ParentBaseFileName>[^\\\\]+)$"
  | where ParentBaseFileName="winword.exe" OR ParentBaseFileName="excel.exe" OR ParentBaseFileName="outlook.exe"
  OR ParentBaseFileName="powerpnt.exe" OR ParentBaseFileName="visio.exe" OR ParentBaseFileName="mspub.exe"
  OR ParentBaseFileName="acrobat.exe" OR ParentBaseFileName="acrord32.exe" OR ParentBaseFileName="iexplore.exe"
  OR ParentBaseFileName="opera.exe" OR ParentBaseFileName="firefox.exe" OR (ParentBaseFileName="java.exe"
  AND (parent_process_name IS NOT NULL AND match_regex(parent_process_name, /(?i)patch1-Hotfix1a/)=false))
  OR ParentBaseFileName="powershell.exe" OR (ParentBaseFileName="chrome.exe" AND (process
  IS NULL OR (process IS NOT NULL AND match_regex(process, /(?i)chrome-extension/)=false)))
  | eval body=create_map("category_id", 101, "class_id", 101000, "detection_start_time", start_time, 
  "detection_end_time", end_time, "device_entities", [create_map("uid", ucast(map_get(input_event, "enrichments.device_entities.device.uid"), "string", null), "type_id", 0)], 
  "disposition_id", 1, "end_time", end_time, "event_id", 10100001, "event_time", timestamp, 
  "finding", create_map("confidence", 50, "confidence_id", 2, 
  "context_ids", [10, 45], "impact", 70, "impact_id", 4,
  "kill_chain_phase", Exploitation, "kill_chain_phase_id", 4, 
  "risk_level", Low, "risk_level_id", 1, "type_id", 1, "ref_event_uid", event_id), 
  "message", An instance of $parent_process_name$ spawning $process_name$ was identified on endpoint $dest_device_id$ by user $dest_user_id$, producing a suspicious event that warrants investigating., "metadata", create_map("log_name", Endpoint_Processes, "version",
  "1.0.0"), "observables", , "origin", create_map("product", create_map("name", "Splunk Behavioral Analytics")), 
  "rule", create_map("name", "Detect Prohibited Applications Spawning cmd exe", "uid", "c10a18cb-fd80-4ffa-a844-25026e0a0c94", "version", "1"), "start_time", start_time, "time", start_time,
  "user_entities", [create_map("uid", ucast(map_get(input_event, "enrichments.user_entities.user.uid"),"string", null))]) | into write_ssa_finding_events();'
how_to_implement: In order to successfully implement this analytic, you will need
  endpoint process data from a EDR product or Sysmon. This search has been modified
  to process raw sysmon data from attack_range's nxlogs on DSP.
known_false_positives: There are circumstances where an application may legitimately
  execute and interact with the Windows command-line interface.
references:
- https://attack.mitre.org/techniques/T1059/
tags:
  analytic_story:
  - Suspicious Command-Line Executions
  cis20:
  - CIS 8
  kill_chain_phases:
  - Exploitation
  mitre_attack_id:
  - T1059
  nist:
  - PR.PT
  - DE.CM
  required_fields:
  - process_name
  - parent_process_name
  - _time
  - dest_device_id
  - dest_user_id
  - process
  security_domain: endpoint
  risk_severity: low
test:
  name: Detect Prohibited Applications Spawning cmd exe Unit Test
  tests:
  - name: Detect Prohibited Applications Spawning cmd exe
    file: endpoint/ssa___prohibited_apps_spawning_cmdprompt.yml
    pass_condition: '@count_gt(0)'
    attack_data:
    - file_name: windows-security.log
      data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1059.003/powershell_spawn_cmd/windows-security.log
      source: WinEventLog:Security
